name: ğŸ¤– ìë™ ëª¨ë¸ í‰ê°€ íŒŒì´í”„ë¼ì¸

on:
  push:
    branches:
      - main
    paths:
      - 'src/dataset/evaluation_data/**'
      - 'src/dataset/finetuning_data/**'
      - 'app/**'
  pull_request:
    branches:
      - main
    paths:
      - 'src/dataset/evaluation_data/**'
      - 'src/dataset/finetuning_data/**'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
    inputs:
      model_name:
        description: 'í‰ê°€í•  ëª¨ë¸ëª…'
        required: false
        default: 'gpt-3.5-turbo-0125'
      max_tokens:
        description: 'ìµœëŒ€ í† í° ìˆ˜'
        required: false
        default: '4096'
      judge_model:
        description: 'Judge ëª¨ë¸ëª…'
        required: false
        default: 'gpt-4'
      threads:
        description: 'í‰ê°€ ìŠ¤ë ˆë“œ ìˆ˜'
        required: false
        default: '10'

env:
  MODEL_NAME: ${{ github.event.inputs.model_name || 'gpt-3.5-turbo-0125' }}
  MAX_TOKENS: ${{ github.event.inputs.max_tokens || '4096' }}
  JUDGE_MODEL: ${{ github.event.inputs.judge_model || 'gpt-4' }}
  THREADS: ${{ github.event.inputs.threads || '10' }}

jobs:
  detect-changes:
    name: ğŸ” ë³€ê²½ì‚¬í•­ ê°ì§€
    runs-on: ubuntu-latest
    outputs:
      has_data_changes: ${{ steps.changes.outputs.has_data_changes }}
      changed_files: ${{ steps.changes.outputs.changed_files }}
    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ë³€ê²½ëœ íŒŒì¼ ê°ì§€
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "has_data_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files=manual_trigger" >> $GITHUB_OUTPUT
          else
            changed_files=$(git diff --name-only HEAD~1 HEAD | grep -E "(src/dataset/|app/)" || echo "")
            if [[ -n "$changed_files" ]]; then
              echo "has_data_changes=true" >> $GITHUB_OUTPUT
              echo "changed_files=$changed_files" >> $GITHUB_OUTPUT
            else
              echo "has_data_changes=false" >> $GITHUB_OUTPUT
            fi
          fi

  inference:
    name: ğŸš€ ëª¨ë¸ ì¶”ë¡ 
    needs: detect-changes
    if: needs.detect-changes.outputs.has_data_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      output_file: ${{ steps.inference.outputs.output_file }}
    
    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4

      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pip install -r requirements.txt

      - name: ì¶”ë¡  ì‹¤í–‰
        id: inference
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          output_file="${MODEL_NAME//\//_}.jsonl"
          echo "output_file=$output_file" >> $GITHUB_OUTPUT
          
          echo "ğŸš€ ëª¨ë¸ ì¶”ë¡  ì‹œì‘: $MODEL_NAME"
          ./scripts/run_inference.sh "$MODEL_NAME" "$MAX_TOKENS" "$OPENAI_API_KEY"
          
          # ê²°ê³¼ íŒŒì¼ ê²€ì¦
          if [[ -f "$output_file" ]]; then
            echo "âœ… ì¶”ë¡  ì™„ë£Œ: $output_file"
            lines=$(wc -l < "$output_file")
            echo "ğŸ“Š ìƒì„±ëœ ê²°ê³¼: $lines ì¤„"
          else
            echo "âŒ ì¶”ë¡  ì‹¤íŒ¨: ì¶œë ¥ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          fi

      - name: ì¶”ë¡  ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: inference-results
          path: "${{ steps.inference.outputs.output_file }}"
          retention-days: 7

  evaluation:
    name: ğŸ” ëª¨ë¸ í‰ê°€
    needs: [detect-changes, inference]
    if: needs.detect-changes.outputs.has_data_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4

      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pip install -r requirements.txt

      - name: ì¶”ë¡  ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v3
        with:
          name: inference-results

      - name: í‰ê°€ ì‹¤í–‰
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          output_file="${MODEL_NAME//\//_}.jsonl"
          echo "ğŸ” ëª¨ë¸ í‰ê°€ ì‹œì‘: $output_file"
          ./scripts/run_eval.sh "$output_file" "$OPENAI_API_KEY" "$JUDGE_MODEL" "$THREADS"

      - name: í‰ê°€ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: evaluation-results
          path: "judge_*.jsonl"
          retention-days: 30

  report:
    name: ğŸ“Š ê²°ê³¼ ë³´ê³ ì„œ
    needs: [detect-changes, inference, evaluation]
    if: always() && needs.detect-changes.outputs.has_data_changes == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4

      - name: í‰ê°€ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        if: needs.evaluation.result == 'success'
        uses: actions/download-artifact@v3
        with:
          name: evaluation-results

      - name: ê²°ê³¼ ìš”ì•½ ìƒì„±
        run: |
          echo "# ğŸ† í•œêµ­ì–´ ê¸ˆìœµ LLM í‰ê°€ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ ì‹¤í–‰ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- **ëª¨ë¸**: $MODEL_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **ìµœëŒ€ í† í°**: $MAX_TOKENS" >> $GITHUB_STEP_SUMMARY
          echo "- **Judge ëª¨ë¸**: $JUDGE_MODEL" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹¤í–‰ ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **ë³€ê²½ëœ íŒŒì¼**: ${{ needs.detect-changes.outputs.changed_files }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.inference.result }}" == "success" ]]; then
            echo "## âœ… ì¶”ë¡  ë‹¨ê³„" >> $GITHUB_STEP_SUMMARY
            echo "ì¶”ë¡ ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ ì¶”ë¡  ë‹¨ê³„" >> $GITHUB_STEP_SUMMARY
            echo "ì¶”ë¡  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.evaluation.result }}" == "success" ]]; then
            echo "## âœ… í‰ê°€ ë‹¨ê³„" >> $GITHUB_STEP_SUMMARY
            echo "í‰ê°€ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            
            # Judge íŒŒì¼ì´ ìˆìœ¼ë©´ ì ìˆ˜ ìš”ì•½ ì¶”ê°€
            if ls judge_*.jsonl 1> /dev/null 2>&1; then
              echo "## ğŸ“Š í‰ê°€ ì ìˆ˜" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              python src/eval/score-single.py -p judge_*.jsonl >> $GITHUB_STEP_SUMMARY 2>&1 || echo "ì ìˆ˜ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ ë°œìƒ" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## âŒ í‰ê°€ ë‹¨ê³„" >> $GITHUB_STEP_SUMMARY
            echo "í‰ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi

      - name: PR ì½”ë©˜íŠ¸ ì‘ì„±
        if: github.event_name == 'pull_request' && needs.evaluation.result == 'success'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            let comment = `# ğŸ¤– ìë™ í‰ê°€ ê²°ê³¼\\n\\n`;
            comment += `**ëª¨ë¸**: ${process.env.MODEL_NAME}\\n`;
            comment += `**Judge ëª¨ë¸**: ${process.env.JUDGE_MODEL}\\n\\n`;
            
            // Judge íŒŒì¼ì—ì„œ ì ìˆ˜ ì½ê¸° ì‹œë„
            try {
              const { execSync } = require('child_process');
              const scoreOutput = execSync('python src/eval/score-single.py -p judge_*.jsonl', {encoding: 'utf8'});
              comment += `## ğŸ“Š í‰ê°€ ì ìˆ˜\\n\`\`\`\\n${scoreOutput}\`\`\`\\n`;
            } catch (error) {
              comment += `í‰ê°€ ì ìˆ˜ë¥¼ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\\n`;
            }
            
            comment += `\\n> ğŸ”— [ìƒì„¸ ê²°ê³¼ ë³´ê¸°](${context.payload.pull_request.html_url}/checks)`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
